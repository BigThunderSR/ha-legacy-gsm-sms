# Copilot Instructions for ha-legacy-gsm-sms

## Critical Rules

### 1. NEVER Copy Entire Files Between Addons

This repository contains multiple addon variants with **intentional differences**:

- `addon-gsm-gateway/` - Production addon
- `addon-test-current/` - Test addon with custom settings
- `addon-test-pavelve/` - Another test variant - Generally not modified

When syncing features or fixes between these addons, make **surgical, line-by-line edits** to preserve custom settings.

**NEVER** copy entire files from one addon to another. Always make surgical, line-by-line edits.

### 2. Test Addon Custom Settings (addon-test-current/)

The test addon has these **intentional differences** that must be preserved:

#### config.yaml
- `name`: Must start with `"TEST - "` prefix
- `version`: Must have `-test` suffix (e.g., `2.14.0-test`)
- `slug`: Must be `"gsm_sms_gateway_test_current"` (NOT the production slug)
- `description`: Must include `üß™ TEST VERSION` and describe what's being tested
- `url`: Must point to `addon-test-current` folder
- `image`: Must be **commented out** to allow local builds

#### support.py
- Contains custom debug logging with `üîç DEBUG:` prefixes
- Do NOT overwrite with production version

### 3. Before Editing Any Config File

1. **Read the file first** using `read_file` or `git show HEAD:path`
2. **Identify what needs to change** - only those specific lines
3. **Make surgical edits** - change only what's necessary
4. **Verify with diff** - check that only intended changes were made

### 4. Tuning Values - Do NOT Change

These values have been tuned for this project and differ from upstream:

- `commtimeout`: 10 (not 40)
- Python timeout: 15 seconds (not 60)
- `sms_check_interval`: 5 seconds

### 5. Syncing Features Between Addons

When adding a new feature to both production and test addons:

1. Implement in production addon first (`addon-gsm-gateway/`)
2. For Python files (`mqtt_publisher.py`, `run.py`): These CAN be synced (except `support.py`)
3. For `config.yaml`: Make **individual line edits** - never copy the whole file
4. Always verify test addon customizations are preserved after changes

### 6. Version Bumping

- Production addon: `X.Y.Z` (e.g., `2.14.0`)
- Test addon: `X.Y.Z-test` (e.g., `2.14.0-test`)

Both should be bumped together when features are added.

### 7. Feature Implementation Checklist

When adding a new SMS feature, it must be implemented in ALL these places:

- [ ] `mqtt_publisher.py` - MQTT command handling
- [ ] `run.py` - REST API endpoint
- [ ] `README.md` - Documentation
- [ ] `CHANGELOG.md` - Release notes

**Don't say "done" until all four are complete.**

### 8. Phone Number Validation

Phone numbers can contain: `+`, digits, spaces, `-`, `(`, `)`, `,`

The `+` character can appear **anywhere** (not just at the start) because multiple international numbers are comma-separated: `+1234567890,+0987654321`

Correct regex: `^[\+\d\s\-\(\),]*$`
Wrong regex: `^\+?[\d\s\-\(\),]*$` (only allows + at start)

### 9. Validation Before Completion

Before saying a task is complete:

1. Run Python syntax check on all modified `.py` files
2. Test the logic with edge cases (multiple values, empty values, special characters)
3. Verify with `git diff` that only intended changes were made
4. Check that both production AND test addons are updated (if applicable)
5. Confirm documentation matches the implementation

### 10. When in Doubt, Ask

If unsure whether a file has custom settings or special handling:
- Check git history: `git log --oneline -5 -- path/to/file`
- Compare with similar files: `diff file1 file2`
- Ask the user before making changes

## Upstream Reference

This project is based on [PavelVe/hassio-addons](https://github.com/PavelVe/hassio-addons).
When syncing upstream features, always credit the source in CHANGELOG.md.
