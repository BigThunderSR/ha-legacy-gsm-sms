#!/command/with-contenv bashio

# Create configuration file for GSM SMS service
CONFIG_PATH=/data/options.json
MODEM_DEVICE=$(bashio::config 'device')
BAUD_SPEED=$(bashio::config 'baud_speed')
UNICODE=$(bashio::config 'unicode')
SCAN_INTERVAL=$(bashio::config 'scan_interval')
SERVICE_NAME=$(bashio::config 'service_name')
LOG_LEVEL=$(bashio::config 'log_level')

# Debug logging
bashio::log.debug "Creating GSM SMS configuration in /data/gsm_sms/config.json"
bashio::log.debug "Device: ${MODEM_DEVICE}"
bashio::log.debug "Baud Speed: ${BAUD_SPEED}"
bashio::log.debug "Unicode: ${UNICODE}"
bashio::log.debug "Scan Interval: ${SCAN_INTERVAL}"
bashio::log.debug "Service Name: ${SERVICE_NAME}"
bashio::log.debug "Log Level: ${LOG_LEVEL}"

# Create configuration for the SMS service
mkdir -p /data/gsm_sms
cat > /data/gsm_sms/config.json << EOL
{
  "device": "${MODEM_DEVICE}",
  "baud_speed": "${BAUD_SPEED}",
  "unicode": ${UNICODE},
  "scan_interval": ${SCAN_INTERVAL},
  "service_name": "${SERVICE_NAME}",
  "log_level": "${LOG_LEVEL}"
}
EOL

# Verify file was created successfully
if [ -f "/data/gsm_sms/config.json" ]; then
    bashio::log.info "GSM SMS configuration created successfully"
    ls -la /data/gsm_sms/config.json
    cat /data/gsm_sms/config.json
else
    bashio::log.error "Failed to create GSM SMS configuration"
fi
